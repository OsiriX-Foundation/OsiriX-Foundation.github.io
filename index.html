<!--

https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/javascript-adapter.adoc
https://www.keycloak.org/docs/4.4/securing_apps/index.html#_javascript_adapter

-->

<html>
  <head>
    <title>View Page</title>
    <script src="https://test.kheops.online:8443/auth/js/keycloak.js"></script>
  </head>

  <body>
    <p id="url"></p>

    <div id="userNotLogged" hidden>
      <p>User not logged</p>
    </div>

    <div id="userDetails" hidden>
      <p><b>User details (from <span id="profileType"></span>)</b></p>
      <p>Username: <span id="username"></span></p>
      <p>Email: <span id="email"></span></p>
      <p>Full Name: <span id="name"></span></p>
      <p>First name: <span id="givenName"></span></p>
      <p>Last name: <span id="familyName"></span></p>
      <p>Token Full: <br /> <span id="token"></span></p>
    </div>

    <script>
      //Conf for the keycloak srv
      var keycloak = Keycloak({
        url: 'https://test.kheops.online:8443/auth',
        realm: 'StaticLoginConnect',
        clientId: 'loginConnect'
      });

      //define an implicit flow
      //check-sso - check if user is already logged
      keycloak.init({flow: 'implicit', checkLoginIframe: true, onLoad: 'check-sso'})
      keycloak.onReady = function(){
        if (!keycloak.authenticated) {
          document.getElementById('url').innerHTML = '<a href="#" onclick="keycloak.login()">Login</a>'
          document.getElementById("userNotLogged").hidden = false
          document.getElementById("userDetails").hidden = true
        }
      }
      //If user is logged, launch the function loadData()
      keycloak.onAuthSuccess = function() {
        console.log(keycloak)
        loadData()
        document.getElementById('url').innerHTML = ' <a href="#" onclick="keycloak.accountManagement()">Account management</a> '+
        '<a href="#" onclick="keycloak.logout()">Logout</a>'
       }

       keycloak.onAuthLogout = function() {
         document.getElementById('url').innerHTML = '<a href="#" onclick="keycloak.login()">Login</a>'
         document.getElementById("userNotLogged").hidden = false
         document.getElementById("userDetails").hidden = true
       }

      var loadData = function () {
        document.getElementById("userNotLogged").hidden = true
        document.getElementById("userDetails").hidden = false
        document.getElementById('profileType').innerHTML = 'IDToken';
        document.getElementById('username').innerHTML = keycloak.idTokenParsed.preferred_username;
        document.getElementById('email').innerHTML = keycloak.idTokenParsed.email;
        document.getElementById('name').innerHTML = keycloak.idTokenParsed.name;
        document.getElementById('givenName').innerHTML = keycloak.idTokenParsed.given_name;
        document.getElementById('familyName').innerHTML = keycloak.idTokenParsed.family_name;
        /*
        var tokerReader = '';
        for (var property in keycloak.idTokenParsed) {
          tokerReader += property + ': ' + keycloak.idTokenParsed[property] + '<br /> ';
        }
        */
        document.getElementById('token').innerHTML = keycloak.token
      }
    </script>

  </body>
</html>
